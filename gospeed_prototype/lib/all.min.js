// GoGraphic
var STONE_SIZE=25;var BOARD_BOUND=10;var SHADOW_LEFT=3;var SHADOW_TOP=1;var SHADOW_SIDE=-1;var MOUSE_ADJUST_Y=0;function GoGraphic(a){this.init.call(this,a)}GoGraphic.prototype={init:function(a){this.game=a;this.validate_and_load_divs();this.grid=Array(this.game.size);for(var c=0,b=this.game.size;c<b;c++){this.grid[c]=Array(b)}this.max_bound=this.game.size*STONE_SIZE+BOARD_BOUND},put_stone:function(b,f,c){var d=document.createElement("div");var a=c*STONE_SIZE+BOARD_BOUND;var e=f*STONE_SIZE+BOARD_BOUND;d.className="Stone"+b;d.style.left=a+"px";d.style.top=e+"px";this.div_board.appendChild(d);var g=document.createElement("div");g.className="Shadow";g.style.left=(a+SHADOW_SIDE*SHADOW_LEFT)+"px";g.style.top=(e+SHADOW_TOP)+"px";this.div_board.appendChild(g);this.clean_t_stones();this.grid[f][c]={stone:d,shadow:g,}},put_little_stone:function(b,f,c){var d=document.createElement("div");var a=c*STONE_SIZE+BOARD_BOUND;var e=f*STONE_SIZE+BOARD_BOUND;d.className="LittleStone"+b;d.style.left=a+"px";d.style.top=e+"px";this.div_board.appendChild(d);if(this.grid[f][c]==undefined){this.grid[f][c]={little_stone:d,}}else{this.grid[f][c].little_stone=d}},place_last_stone_wait_marker:function(a){this.clear_last_stone_markers();this.last_stone_wait[a.color].style.left=(a.col*STONE_SIZE+BOARD_BOUND)+"px";this.last_stone_wait[a.color].style.top=(a.row*STONE_SIZE+BOARD_BOUND)+"px";this.last_stone_wait[a.color].style.display="block"},place_last_stone_marker:function(a){this.clear_last_stone_markers();this.last_stone[a.color].style.left=(a.col*STONE_SIZE+BOARD_BOUND)+"px";this.last_stone[a.color].style.top=(a.row*STONE_SIZE+BOARD_BOUND)+"px";this.last_stone[a.color].style.display="block"},clear_last_stone_markers:function(){this.last_stone.W.style.display="none";this.last_stone.B.style.display="none";this.last_stone_wait.W.style.display="none";this.last_stone_wait.B.style.display="none"},confirm_play:function(a){this.place_last_stone_marker(a)},place_coord_marker:function(b,a){this.coord_marker.style.left=(a*STONE_SIZE+BOARD_BOUND)+"px";this.coord_marker.style.top=(b*STONE_SIZE+BOARD_BOUND)+"px";this.coord_marker.style.display="block"},clear_coord_marker:function(){this.coord_marker.style.display="none"},place_ko:function(a){this.ko.style.left=(a.col*STONE_SIZE+BOARD_BOUND)+"px";this.ko.style.top=(a.row*STONE_SIZE+BOARD_BOUND)+"px";this.ko.style.display="block"},clear_ko:function(){this.ko.style.display="none"},refresh_ko:function(a){if(a&&a.ko){this.place_ko(a.ko)}else{this.clear_ko()}},remove_stone:function(c,a){var b=this.grid[c][a];if(b!=undefined&&b.stone!=undefined&&b.shadow!=undefined){this.div_board.removeChild(b.stone);this.div_board.removeChild(b.shadow);if(b.little_stone==undefined){this.grid[c][a]=undefined}else{b.stone=undefined;b.shadow=undefined}}},remove_little_stone:function(c,a){var b=this.grid[c][a];if(b!=undefined&&b.little_stone!=undefined){this.div_board.removeChild(b.little_stone);if(b.stone==undefined&&b.shadow==undefined){this.grid[c][a]=undefined}else{b.little_stone=undefined}}},draw_play:function(c,b){this.clear_last_stone_markers();if(c instanceof FreePlay){for(var a in c.remove){this.remove_stone(c.remove[a].row,c.remove[a].col)}for(var a in c.put){this.put_stone(c.put[a].color,c.put[a].row,c.put[a].col)}}else{if(c instanceof Play){this.put_stone(c.put.color,c.put.row,c.put.col);if(b){this.place_last_stone_wait_marker(c.put)}else{this.place_last_stone_marker(c.put)}for(var a in c.remove){this.remove_stone(c.remove[a].row,c.remove[a].col)}this.refresh_ko(c)}else{if(c instanceof Pass){this.refresh_ko(c)}}}},undraw_play:function(b){if(b instanceof FreePlay){for(var a in b.put){this.remove_stone(b.put[a].row,b.put[a].col)}for(var a in b.remove){this.put_stone(b.remove[a].color,b.remove[a].row,b.remove[a].col)}}else{if(b instanceof Play){this.remove_stone(b.put.row,b.put.col);for(var a in b.remove){this.put_stone(b.remove[a].color,b.remove[a].row,b.remove[a].col)}}}this.clear_last_stone_markers()},draw_number:function(b,a){this.clear_last_stone_markers();if(b instanceof Play){if(b.put){var c=this.grid[b.put.row][b.put.col];if(c!=undefined&&c.stone!=undefined){c.stone.innerHTML=a}}}},update_captures:function(a){if(a!=undefined&&a.captured!=undefined){if(this.div_captured_w!=undefined){this.div_captured_w.innerHTML=a.captured.W}if(this.div_captured_b!=undefined){this.div_captured_b.innerHTML=a.captured.B}}else{if(this.div_captured_w!=undefined){this.div_captured_w.innerHTML="0"}if(this.div_captured_b!=undefined){this.div_captured_b.innerHTML="0"}}},update_move_number:function(a){if(this.div_move_number!=undefined){if(a!=undefined&&a.turn_number!=undefined){this.div_move_number.innerHTML=a.turn_number}}},update_score:function(a){if(a!=undefined){if(this.div_score_w!=undefined){this.div_score_w.innerHTML=a.W}if(this.div_score_b!=undefined){this.div_score_b.innerHTML=a.B}}else{if(this.div_score_w!=undefined){this.div_score_w.innerHTML=""}if(this.div_score_b!=undefined){this.div_score_b.innerHTML=""}}},update_result:function(a){if(this.div_result!=undefined){if(a!=undefined){this.div_result.innerHTML=a}else{this.div_result.innerHTML=""}}},update_comments:function(){if(this.div_comments!=undefined){var a=this.game.game_tree.actual_move;if(a.comments!=undefined&&a.turn_number!=undefined){this.div_comments.innerHTML="<strong>Move "+a.turn_number+"</strong><br />"+a.comments.replace(/(\r\n|\n|\r)/gm,"<br />")}else{this.div_comments.innerHTML=""}}},draw_score:function(g){for(var d=0,b=g.groups.length;d<b;++d){var f=g.groups[d];var a=f.owner;var e=f.coords;if(a==BLACK||a==WHITE){for(var c=0,h=e.length;c<h;++c){this.put_little_stone(a,e[c].row,e[c].col)}}}},stone_dead:function(b,f,c){this.grid[f][c].stone.style.display="none";this.grid[f][c].shadow.style.display="none";var d=document.createElement("div");var a=c*STONE_SIZE+BOARD_BOUND;var e=f*STONE_SIZE+BOARD_BOUND;d.className="StoneT"+b;d.style.left=a+"px";d.style.top=e+"px";d.style.display="block";this.div_board.appendChild(d);this.grid[f][c].t_stone=d},stone_revive:function(a,d,b){var c=this.grid[d][b];if(c.t_stone!=undefined){this.div_board.removeChild(c.t_stone)}c.t_stone=undefined;c.stone.style.display="block";c.shadow.style.display="block"},draw_dead_groups:function(e){for(var c=0,a=e.length;c<a;++c){var d=e[c];for(var b=0,f=d.length;b<f;++b){this.stone_dead(d[b].color,d[b].row,d[b].col)}}},clear_dead_groups:function(e){for(var c=0,a=e.length;c<a;++c){var d=e[c];for(var b=0,f=d.length;b<f;++b){this.stone_revive(d[b].color,d[b].row,d[b].col)}}},clear_score:function(){for(var c=0,b=this.game.size;c<b;c++){for(var a=0;a<b;a++){this.remove_little_stone(c,a)}}},binder:function(c,b,a){return function(d){c.apply(b,[d].concat(a))}},click_handler:function(b){if(b){event=b}if("pageX" in event){var d=event.pageX;var c=event.pageY+MOUSE_ADJUST_Y}else{var d=event.clientX+document.documentElement.scrollLeft;var c=event.clientY+document.documentElement.scrollTop+MOUSE_ADJUST_Y}var h=d-this.div_board.offsetLeft+1;var f=c-this.div_board.offsetTop+1;if(h>BOARD_BOUND&&h<this.max_bound&&f>BOARD_BOUND&&f<this.max_bound){var a=parseInt((h-BOARD_BOUND)/STONE_SIZE,10);var g=parseInt((f-BOARD_BOUND)/STONE_SIZE,10);if(this.game.callbacks.rgf_board_click!=undefined){var e=true;e=e&&(this.game.mode=="play");e=e&&!event.shiftKey&&!event.ctrlKey;e=e&&this.game.setup_play(g,a);if(e){if(!this.game.callbacks.rgf_board_click(g,a)){return false}}else{return false}}this.game.play(g,a,event.shiftKey,event.ctrlKey)}},mousemove_handler:function(h){if(!this.game.connected){return false}if(h){event=h}if("pageX" in event){var f=event.pageX;var e=event.pageY+MOUSE_ADJUST_Y}else{var f=event.clientX+document.documentElement.scrollLeft;var e=event.clientY+document.documentElement.scrollTop+MOUSE_ADJUST_Y}var d;if(this.game.mode=="count"||(this.game.mode=="count_online"&&this.game.my_colour!="O")){this.clean_t_stones();var c=f-this.div_board.offsetLeft+1;var b=e-this.div_board.offsetTop+1;if(c<=BOARD_BOUND||c>=this.max_bound||b<=BOARD_BOUND||b>=this.max_bound){return false}var a=parseInt((c-BOARD_BOUND)/STONE_SIZE,10);var j=parseInt((b-BOARD_BOUND)/STONE_SIZE,10);var i=this.game.get_pos(j,a);if(i=="B"){if(event.shiftKey){d=this.revive_b}else{d=this.t_little_white}}else{if(i=="W"){if(event.shiftKey){d=this.revive_w}else{d=this.t_little_black}}else{return false}}d.style.left=(a*STONE_SIZE+BOARD_BOUND)+"px";d.style.top=(j*STONE_SIZE+BOARD_BOUND)+"px";d.style.display="block";return false}else{switch(this.game.mode){case"free":d=this.t_white;break;case"play":case"variation":if(this.game.get_next_move()=="B"){d=this.t_black}else{d=this.t_white}break;case"play_online":if(this.game.is_my_turn()){if(this.game.get_next_move()=="B"){d=this.t_black}else{d=this.t_white}}else{d=null}break}if(d==null){this.clean_t_stones();return false}var c=f-this.div_board.offsetLeft+1;var b=e-this.div_board.offsetTop+1;if(c<=BOARD_BOUND||c>=this.max_bound||b<=BOARD_BOUND||b>=this.max_bound){d.style.display="none";return false}var a=parseInt((c-BOARD_BOUND)/STONE_SIZE,10);var j=parseInt((b-BOARD_BOUND)/STONE_SIZE,10);if(this.game.get_pos(j,a)!=undefined){d.style.display="none";return false}if(this.game.pos_is_ko(j,a)){d.style.display="none";return false}var g=new Play(this.game.get_next_move(),j,a);this.game.play_eat(g);if(this.game.play_check_suicide(g)){d.style.display="none";return false}d.style.left=(a*STONE_SIZE+BOARD_BOUND)+"px";d.style.top=(j*STONE_SIZE+BOARD_BOUND)+"px";d.style.display="block"}},mouseout_handler:function(a){if(a){event=a}var b=false;if(event.relatedTarget==null){this.clean_t_stones()}else{if(event.relatedTarget==this.div_board){return}if(event.relatedTarget.parentNode!=this.div_board){this.clean_t_stones()}}},update_clocks:function(e){function d(i,g){var f;var h;if(g){if(i>0){f=Math.floor(i/60);h=Math.floor(i-f*60);if(f<10){f="0"+f}if(h<10){h="0"+h}}else{f="00";h="00"}return f+":"+h}else{if(i>0){h=Math.floor(i);if(h<10){h="0"+h}}else{h="00"}return h}}var c=this.game.timer;var a=[BLACK,WHITE];switch(c.system.name){case"Absolute":case"Fischer":case"Bronstein":case"Hourglass":for(var b in a){b=a[b];this.handle_clock_sound(e[b],b);this.format_clock_div(e[b],b);this.div_clocks[b].innerHTML=d(e[b]+0.99,true);this.draw_t_stone_number(e[b],b)}break;case"Byoyomi":for(var b in a){b=a[b];if(e[b].main_time>0){this.handle_clock_sound(e[b].main_time,b);this.format_clock_div(e[b].main_time,b);this.div_clocks[b].innerHTML=d(e[b].main_time+0.99,true);this.draw_t_stone_number(e[b].main_time,b)}else{if(e[b].periods<=1){this.handle_clock_sound(e[b].period_time,b);this.format_clock_div(e[b].period_time,b);this.div_clocks[b].innerHTML=d(e[b].period_time+0.99)+" SD";this.draw_t_stone_number(e[b].period_time,b)}else{this.handle_clock_sound(e[b].period_time,b);this.format_clock_div(e[b].period_time,b);this.div_clocks[b].innerHTML=d(e[b].period_time+0.99)+" ("+e[b].periods+")";this.draw_t_stone_number(e[b].period_time,b)}}}break;case"Canadian":if(e[BLACK].main_time>0){this.div_clocks[BLACK].innerHTML=d(e[BLACK].main_time+0.99,true)}else{this.div_clocks[BLACK].innerHTML=d(e[BLACK].period_time+0.99,true)+" / "+e[BLACK].period_stones}if(e[WHITE].main_time>0){this.div_clocks[WHITE].innerHTML=d(e[WHITE].main_time+0.99,true)}else{this.div_clocks[WHITE].innerHTML=d(e[WHITE].period_time+0.99,true)+" / "+e[WHITE].period_stones}break}},handle_clock_sound:function(e,a){if(typeof KAYAGLOBAL!=="undefined"){if(this.game.is_my_turn()&&this.game.my_colour==a){var c=Math.floor(e);if(!KAYAGLOBAL.is_playing){if(e>0&&e<11){var d=10-c;var b=(e-c)*1000;return KAYAGLOBAL.delayed_play_sound("countdown",d,b)}if(e>60&&e<61){var b=(e-c)*1000;return KAYAGLOBAL.delayed_play_sound("oneminute",0,b)}if(e>300&&e<301){var b=(e-c)*1000;return KAYAGLOBAL.delayed_play_sound("fiveminutes",0,b)}}}}return false},draw_t_stone_number:function(c,a){var b=Math.floor(c+0.99);if(this.my_colour!="O"){if(a==this.game.get_next_move()){if(Math.floor(b)>0&&Math.floor(b)<=10){if(a==BLACK){this.t_black.innerHTML=Math.floor(b)}else{this.t_white.innerHTML=Math.floor(b)}}else{if(a==BLACK){this.t_black.innerHTML=""}else{this.t_white.innerHTML=""}}}}},format_clock_div:function(d,a){var b=Math.floor(d+0.99);var c=this.div_clocks[a];if(a==this.game.get_next_move()){if(d<=0){c.style.color="#800"}else{if(b>0&&b<=10){if(b%2==0){c.style.color="#EEE"}else{c.style.color=""}}else{c.style.color=""}}}else{c.style.color=""}},render:function(){switch(this.game.size){case 19:this.div_board.style.width="495px";this.div_board.style.height="495px";this.div_board.className="OnlyBoard19";break;case 13:this.div_board.style.width="346px";this.div_board.style.height="346px";this.div_board.className="OnlyBoard13";break;case 9:this.div_board.style.width="246px";this.div_board.style.height="246px";this.div_board.className="OnlyBoard9";break}this.div_board.style.position="relative";var a="";if(this.game.server_path_gospeed_root!=undefined){a=this.game.server_path_gospeed_root}(new Image()).src=a+"img/white.png";(new Image()).src=a+"img/black.png";(new Image()).src=a+"img/t_white.png";(new Image()).src=a+"img/t_black.png";(new Image()).src=a+"img/shadow.png";(new Image()).src=a+"img/last_stone_w.png";(new Image()).src=a+"img/last_stone_b.png";(new Image()).src=a+"img/last_stone_wait_w.gif";(new Image()).src=a+"img/last_stone_wait_b.gif";(new Image()).src=a+"img/little_white.png";(new Image()).src=a+"img/little_black.png";(new Image()).src=a+"img/t_little_white.png";(new Image()).src=a+"img/t_little_black.png";this.t_white=this.create_elem("div","StoneTW",true);this.t_black=this.create_elem("div","StoneTB",true);this.t_little_white=this.create_elem("div","LittleStoneTW",true);this.t_little_black=this.create_elem("div","LittleStoneTB",true);this.revive_w=this.create_elem("div","ReviveStoneW",true);this.revive_b=this.create_elem("div","ReviveStoneB",true);this.last_stone=[];this.last_stone.W=this.create_elem("div","LastStoneW",true);this.last_stone.B=this.create_elem("div","LastStoneB",true);this.last_stone_wait=[];this.last_stone_wait.W=this.create_elem("div","LastStoneWaitW",true);this.last_stone_wait.B=this.create_elem("div","LastStoneWaitB",true);this.ko=this.create_elem("div","Ko");this.coord_marker=this.create_elem("div","CoordMarker",true);this.div_board.onclick=this.binder(this.click_handler,this,null);this.div_board.onmousemove=this.binder(this.mousemove_handler,this,null);this.div_board.onmouseout=this.binder(this.mouseout_handler,this,null);this.update_captures(this.game.game_tree.actual_move.play);this.update_move_number(this.game.game_tree.actual_move)},create_elem:function(a,d,c){var b=document.createElement(a);b.className=d;if(c){b.style.display="none"}this.div_board.appendChild(b);return b},clean_t_stones:function(){this.t_white.style.display="none";this.t_black.style.display="none";this.t_little_white.style.display="none";this.t_little_black.style.display="none";this.revive_b.style.display="none";this.revive_w.style.display="none"},clear:function(){this.grid=Array(this.game.size);for(var a=0;a<this.game.size;a++){this.grid[a]=Array(this.game.size)}this.max_bound=this.game.size*STONE_SIZE+BOARD_BOUND;this.div_board.innerHTML=""},redraw:function(){this.clear();this.render();var b;for(var d=0,a=this.game.size;d<a;++d){for(var c=0;c<a;++c){b=this.game.grid[d][c];if(b!=undefined){this.put_stone(b,d,c)}}}var e=this.game.game_tree.actual_move;this.refresh_ko(e.play);this.update_captures(e.play);this.update_move_number(e);if(e.play instanceof Play){this.place_last_stone_marker(e.play.put)}},validate_and_load_divs:function(){if(this.game.div_id_board!=undefined){this.div_board=document.getElementById(this.game.div_id_board);if(this.div_board){this.div_board.innerHTML=""}else{throw new Error("GoGraphic: error finding board div.")}}this.div_clocks={};if(this.game.div_id_clock_w!=undefined){this.div_clocks[WHITE]=document.getElementById(this.game.div_id_clock_w);if(this.div_clocks[WHITE]){this.div_clocks[WHITE].innerHTML=""}else{throw new Error("GoGraphic: error finding white clock div.")}}if(this.game.div_id_clock_b!=undefined){this.div_clocks[BLACK]=document.getElementById(this.game.div_id_clock_b);if(this.div_clocks[BLACK]){this.div_clocks[BLACK].innerHTML=""}else{throw new Error("GoGraphic: error finding black clock div.")}}if(this.game.div_id_captured_w!=undefined){this.div_captured_w=document.getElementById(this.game.div_id_captured_w);if(this.div_captured_w){this.div_captured_w.innerHTML=""}else{throw new Error("GoGraphic: error finding white captured div.")}}if(this.game.div_id_captured_b!=undefined){this.div_captured_b=document.getElementById(this.game.div_id_captured_b);if(this.div_captured_b){this.div_captured_b.innerHTML=""}else{throw new Error("GoGraphic: error finding black captured div.")}}if(this.game.div_id_score_w!=undefined){this.div_score_w=document.getElementById(this.game.div_id_score_w);if(!this.div_score_w){throw new Error("GoGraphic: error finding white score div.")}}if(this.game.div_id_score_b!=undefined){this.div_score_b=document.getElementById(this.game.div_id_score_b);if(!this.div_score_b){throw new Error("GoGraphic: error finding black score div.")}}if(this.game.div_id_result!=undefined){this.div_result=document.getElementById(this.game.div_id_result);if(!this.div_result){throw new Error("GoGraphic: error finding result div.")}}if(this.game.div_id_comments!=undefined){this.div_comments=document.getElementById(this.game.div_id_comments);if(!this.div_comments){throw new Error("GoGraphic: error finding comments div.")}}if(this.game.div_id_move_number!=undefined){this.div_move_number=document.getElementById(this.game.div_id_move_number);if(!this.div_move_number){throw new Error("GoGraphic: error finding move_number div.")}}},};
// GoSpeed
var TRACK_ONLINE=0;var TRACK_OFFLINE=1;var TRACK_VARIATION=2;function GoSpeed(a){this.init.apply(this,[a])}GoSpeed.prototype={init:function(){this.validator=new GoValidate(arguments);var b=this.validator.clean_args;this.size=b.size;this.mode=b.mode;this.ruleset=b.ruleset;this.komi=b.komi;this.grid=Array(this.size);for(var c=0;c<this.size;c++){this.grid[c]=Array(this.size)}if(b.div_id_board!=undefined){this.div_id_board=b.div_id_board;var a=document.getElementById(b.div_id_board);if(a&&a.innerHTML!=""){this.sgf=new SGFParser(a.innerHTML)}}if(b.time_settings!=undefined){if(b.time_settings.div_id_clock_w!=undefined){this.div_id_clock_w=b.time_settings.div_id_clock_w}if(b.time_settings.div_id_clock_b!=undefined){this.div_id_clock_b=b.time_settings.div_id_clock_b}}if(b.div_id_captured_w!=undefined){this.div_id_captured_w=b.div_id_captured_w}if(b.div_id_captured_b!=undefined){this.div_id_captured_b=b.div_id_captured_b}if(b.div_id_score_w!=undefined){this.div_id_score_w=b.div_id_score_w}if(b.div_id_score_b!=undefined){this.div_id_score_b=b.div_id_score_b}if(b.div_id_result!=undefined){this.div_id_result=b.div_id_result}if(b.div_id_comments!=undefined){this.div_id_comments=b.div_id_comments}if(b.div_id_move_number!=undefined){this.div_id_move_number=b.div_id_move_number}if(b.shower!=undefined){if(b.shower=="basic"){this.shower=new GoShower(this)}else{if(b.shower=="graphic"){this.shower=new GoGraphic(this)}}}if(b.time_settings!=undefined){this.setup_timer(b.time_settings)}this.game_tree=new GameTree(b.div_id_tree);this.div_id_tree=b.div_id_tree;if(b.my_colour!=undefined){this.my_colour=b.my_colour}if(b.my_nick!=undefined){this.my_nick=b.my_nick}this.connected=(this.mode!="play_online"&&this.mode!="count_online");this.tracks=[];this.tracks[0]=new Track(this.grid,this.game_tree.actual_move);this.actual_track=0;this.turn_count=0;this.callbacks=b.callbacks||{};if(b.server_path_gospeed_root!=undefined){this.server_path_gospeed_root=b.server_path_gospeed_root}if(b.server_path_absolute_url!=undefined){this.server_path_absolute_url=b.server_path_absolute_url}if(b.server_path_game_move!=undefined){this.server_path_game_move=b.server_path_game_move}if(b.server_path_game_end!=undefined){this.server_path_game_end=b.server_path_game_end}this.render()},put_stone:function(a,c,b){if(typeof a!="string"){throw new Error("Wrong type of color")}if(a!="B"&&a!="W"){throw new Error("Wrong color")}if(c>=this.size||b>=this.size){throw new Error("Stone out of board")}this.grid[c][b]=a},remove_stone:function(b,a){if(b<0||b>=this.size||a<0||a>=this.size){throw new Error("Position out of board")}this.grid[b][a]=undefined},get_pos:function(b,a){if(b<0||b>=this.size||a<0||a>=this.size){throw new Error("Position out of board")}return this.grid[b][a]},safe_get_pos:function(b,a){if(b<0||b>=this.size||a<0||a>=this.size){return""}else{return this.grid[b][a]}},pos_is_ko:function(d,c){var b=false;var a=this.get_ko();if(a!=undefined){if(a.row==d&&a.col==c){b=true}}return b},make_play:function(b){if(b instanceof FreePlay){for(var a in b.remove){this.remove_stone(b.remove[a].row,b.remove[a].col)}for(var a in b.put){this.put_stone(b.put[a].color,b.put[a].row,b.put[a].col)}}else{if(b instanceof Play){this.put_stone(b.put.color,b.put.row,b.put.col);for(var a in b.remove){this.remove_stone(b.remove[a].row,b.remove[a].col)}}}},undo_play:function(b){if(b instanceof FreePlay){for(var a in b.put){this.remove_stone(b.put[a].row,b.put[a].col)}for(var a in b.remove){this.put_stone(b.remove[a].color,b.remove[a].row,b.remove[a].col)}}else{if(b instanceof Play){this.remove_stone(b.put.row,b.put.col);for(var a in b.remove){this.put_stone(b.remove[a].color,b.remove[a].row,b.remove[a].col)}}}},play_eat:function(e){this.put_stone(e.put.color,e.put.row,e.put.col);var f=(e.put.color=="W"?"B":"W");var a=this.get_touched(f,e.put.row,e.put.col);var d=this.get_distinct_chains(a);for(var b in d){if(this.chain_is_restricted(d[b])){for(var c in d[b]){e.remove.push(new Stone(f,d[b][c].row,d[b][c].col))}}}this.remove_stone(e.put.row,e.put.col)},play_check_ko:function(c){var b=false;var a;this.make_play(c);if(c.remove.length==1){a=new Play(c.remove[0].color,c.remove[0].row,c.remove[0].col);this.play_eat(a);if(a.remove.length==1){if(c.put.equals(a.remove[0])&&a.put.equals(c.remove[0])){b=true}}}this.undo_play(c);if(b){c.ko={row:a.put.row,col:a.put.col,}}else{c.ko=undefined}},get_ko:function(){return this.game_tree.actual_move.play&&this.game_tree.actual_move.play.ko},get_captured_count:function(){var a=this.game_tree.actual_move.play;if(a==undefined||a==null){return{B:0,W:0}}else{return a.captured}},play_check_suicide:function(c){var b=false;if(c.remove.length==0){if(this.count_stone_liberties(c.put)==0){this.put_stone(c.put.color,c.put.row,c.put.col);var a=this.get_distinct_chains([c.put])[0];if(this.chain_is_restricted(a)){b=true}this.remove_stone(c.put.row,c.put.col)}}return b},commit_play:function(b,c,a){this.game_tree.append(new GameNode(b,c),(c!=NODE_VARIATION));this.make_play(b);if(this.shower){this.shower.draw_play(b,a);this.shower.update_captures(b);this.shower.update_move_number(this.game_tree.actual_move)}},get_next_move:function(){var a=this.game_tree.actual_move;while(true){if(a.root){if(a.next_move!=undefined){return a.next_move}else{return"B"}}if(a.play instanceof FreePlay){a=a.prev}else{return(a.play.put.color=="W"?"B":"W")}}},prev:function(b){if(this.is_attached()){this.detach_head()}var a=this.game_tree.prev();if(a){this.undo_play(a.play);if(!b){if(this.shower){this.shower.undraw_play(a.play);if(this.game_tree.actual_move.play instanceof Play){this.shower.place_last_stone_marker(this.game_tree.actual_move.play.put)}}}a=this.game_tree.actual_move;if(a.play){if(!b){if(this.shower!=undefined){this.shower.refresh_ko(a.play);this.shower.update_captures(a.play)}}}}if(!b){if(this.shower){this.shower.clean_t_stones();this.shower.update_comments();this.shower.update_move_number(a)}this.render_tree()}return !!a},next:function(a,c){var b=this.game_tree.next(a);if(b){this.make_play(b.play);if(!c){if(this.shower){this.shower.draw_play(b.play);this.shower.update_captures(b.play)}}}if(!c){if(this.shower){this.shower.clean_t_stones();this.shower.update_comments();this.shower.update_move_number(b)}this.render_tree()}return !!b},up:function(){this.game_tree.up();this.render_tree()},down:function(){this.game_tree.down();this.render_tree()},fast_forward:function(a){while(a>0&&this.next(undefined,true)){a--}if(this.shower!=undefined){this.shower.redraw()}this.render_tree()},fast_backward:function(a){while(a>0&&this.prev(true)){a--}if(this.shower!=undefined){this.shower.redraw()}this.render_tree()},goto_start:function(a){while(this.prev(true)){continue}if(!a){if(this.shower!=undefined){this.shower.redraw()}this.render_tree()}},goto_end:function(){while(this.next(undefined,true)){continue}if(this.shower!=undefined){this.shower.redraw()}this.render_tree()},goto_path:function(c){if(this.game_tree.test_path(c)){this.goto_start(true);for(var b=0,a=c.length;b<a;++b){this.next(c[b],true)}if(this.shower!=undefined){this.shower.redraw()}this.render_tree();return true}else{return false}},get_path:function(){if(this.game_tree!=undefined&&this.game_tree.actual_move!=undefined){return this.game_tree.actual_move.get_path()}},play:function(p,f,e,a){if(a&&this.callbacks.coord_marker!=undefined){this.callbacks.coord_marker(p,f);return false}if(!this.connected){return false}var c=false;var m;switch(this.mode){case"play":m=this.setup_play(p,f);if(m){var h;if(this.timer!=undefined){h=this.timer.pause(true)[this.get_next_move()]}m.time_left=h;this.commit_play(m,NODE_OFFLINE);if(this.timer!=undefined){this.timer.resume(this.get_next_move());this.timer.tick()}c=true}break;case"play_online":if(!this.is_my_turn()){return false}m=this.setup_play(p,f);if(m){var n;var h;if(this.timer!=undefined){n=this.timer.pause(true);h=n[this.get_next_move()]}m.time_left=h;this.commit_play(m,NODE_ONLINE,true);if(this.sgf!=undefined){this.sgf.moves_loaded+=this.data_to_sgf_node(m)}if(KAYAGLOBAL!=undefined){KAYAGLOBAL.play_sound((this.get_next_move()=="W"?"B":"W"))}this.turn_count++;this.send_play(m,n);c=true}break;case"variation":m=this.setup_play(p,f);if(m){this.commit_play(m,NODE_VARIATION);c=true}break;case"free":if(this.game_tree.actual_move==null){this.game_tree.append(new GameNode(new FreePlay()),true)}else{if(this.game_tree.actual_move.play instanceof FreePlay){if(this.game_tree.actual_move.next.length>0){this.game_tree.append(new GameNode(new FreePlay()),true)}}else{this.game_tree.append(new GameNode(new FreePlay()),true)}}var d=this.game_tree.actual_move.play;if(d.captured==undefined){if(this.game_tree.actual_move.prev.play==null){d.captured={B:0,W:0}}else{var b=this.game_tree.actual_move.prev.play.captured;d.captured={B:b.B,W:b.W,}}}var l=d.get_put_by_pos(p,f);var o=d.get_rem_by_pos(p,f);switch(this.get_pos(p,f)){case"W":if(!o&&!l){d.remove.push(new Stone("W",p,f));d.put.push(new Stone("B",p,f))}else{d.put.splice(l[0],1);d.put.push(new Stone("B",p,f))}this.remove_stone(p,f);this.put_stone("B",p,f);if(this.shower){this.shower.remove_stone(p,f);this.shower.put_stone("B",p,f)}break;case"B":if(!o&&!l){d.remove.push(new Stone("B",p,f))}else{d.put.splice(l[0],1)}this.remove_stone(p,f);if(this.shower){this.shower.remove_stone(p,f)}break;default:d.put.push(new Stone("W",p,f));this.put_stone("W",p,f);if(this.shower){this.shower.put_stone("W",p,f)}break}c=true;break;case"count":case"count_online":if(this.mode=="count_online"&&this.my_colour=="O"){return false}var k=this.get_pos(p,f);if(k==undefined){return false}if(this.shower!=undefined){this.shower.clear_dead_groups(this.score.dead_groups)}var g;if(e){g=this.score.revive_stone(k,p,f)}else{g=this.score.kill_stone(k,p,f)}this.draw_score();if(this.mode=="count_online"){if(g){this.send_score_state(p,f,e)}}break}if(c){this.render_tree()}return c},setup_play:function(c,a){if(this.get_pos(c,a)!=undefined){return false}if(this.pos_is_ko(c,a)){return false}var b=new Play(this.get_next_move(),c,a);this.play_eat(b);if(this.play_check_suicide(b)){return false}this.play_check_ko(b);this.update_play_captures(b);return b},update_play_captures:function(d){var c=this.game_tree.actual_move;if(c.root!=undefined&&c.root){d.captured={B:0,W:0}}else{var b=c.play.captured;d.captured={B:b.B,W:b.W,}}for(var a in d.remove){d.captured[d.remove[a].color]++}},is_my_turn:function(){return(this.my_colour=="A"||this.my_colour==this.get_next_move())},pass:function(){var b;switch(this.mode){case"play":var a=this.get_next_move();var e;if(this.timer!=undefined){e=this.timer.pause(true)[a]}var d=new Pass(a);d.time_left=e;this.update_play_captures(d);this.game_tree.append(new GameNode(d,NODE_OFFLINE),true);if(this.shower!=undefined){this.shower.clear_ko();this.shower.clear_last_stone_markers()}if(this.timer!=undefined){this.timer.resume(this.get_next_move());this.timer.tick()}b=true;break;case"play_online":if(!this.is_my_turn()){return false}var a=this.get_next_move();var c;var e;if(this.timer!=undefined){c=this.timer.pause(true);e=c[a]}var d=new Pass(a);d.time_left=e;this.update_play_captures(d);this.game_tree.append(new GameNode(d),NODE_ONLINE,true);if(this.shower!=undefined){this.shower.clear_ko();this.shower.clear_last_stone_markers()}if(this.sgf!=undefined){this.sgf.moves_loaded+=this.data_to_sgf_node(d)}if(KAYAGLOBAL!=undefined){KAYAGLOBAL.play_sound("pass")}this.turn_count++;this.send_play(d,c);b=true;break}return b},chain_is_restricted:function(a){for(var b in a){if(this.count_stone_liberties(a[b])>0){return false}}return true},get_adjacent:function(a,d,b){var c=[];for(i=d-1;i<=d+1;i++){for(j=b-1;j<=b+1;j++){if(this.safe_get_pos(i,j)==a){c.push({color:a,row:i,col:j})}}}return c},get_touched:function(a,d,b){var c=[];if(this.safe_get_pos(d-1,b)==a){c.push({color:a,row:d-1,col:b})}if(this.safe_get_pos(d,b-1)==a){c.push({color:a,row:d,col:b-1})}if(this.safe_get_pos(d,b+1)==a){c.push({color:a,row:d,col:b+1})}if(this.safe_get_pos(d+1,b)==a){c.push({color:a,row:d+1,col:b})}return c},count_stone_liberties:function(a){var b=0;if(this.safe_get_pos(a.row-1,a.col)==undefined){b++}if(this.safe_get_pos(a.row,a.col-1)==undefined){b++}if(this.safe_get_pos(a.row,a.col+1)==undefined){b++}if(this.safe_get_pos(a.row+1,a.col)==undefined){b++}return b},list_has_stone:function(c,a){for(var b in c){if(c[b].color==a.color&&c[b].row==a.row&&c[b].col==a.col){return true}}return false},get_distinct_chains:function(f){var g=[];var e=[];var d;var a;for(d in f){g.push([f[d]]);e.push([f[d]])}granloop:for(var b in e){while(e[b].length>0){a=[];d=e[b].pop();a=this.get_touched(d.color,d.row,d.col);for(d in a){if(this.list_has_stone(g[b],a[d])){continue}else{for(var c in g){if(this.list_has_stone(g[c],a[d])){delete g[b];delete e[b];continue granloop}}g[b].push(a[d]);e[b].push(a[d])}}}}return g},render_tree:function(){this.game_tree.render_tree()},get_next_track_id:function(a){var b=0;if(a==undefined){while(this.tracks[b]!=undefined){b++}}else{if(this.tracks[a]==undefined){b=a}else{throw new Error("Can't force track id. Already in use.")}}return b},create_empty_track:function(e){var g=this.get_next_track_id(e);var d=Array(this.size);for(var b=0,a=this.size;b<a;++b){d[b]=Array(a)}this.tracks[g]=new Track(d,this.game_tree.root);var f=this.actual_track;var c=this.game_tree.root.play;if(c){this.switch_to_track(g,true);this.make_play(c);this.switch_to_track(f,true)}return g},duplicate_actual_track:function(d){var e=this.get_next_track_id(d);var c=[];for(var b=0,a=this.size;b<a;++b){c.push(this.grid[b].slice())}this.tracks[e]=new Track(c,this.game_tree.actual_move);return e},load_track:function(d,k){var e=/^(\d\d?\d?)(\ )+([a-s]{2})+$/;if(!e.test(d)){return false}var h=d.match(/\d\d?\d?/)[0];var c=this.actual_track;var b=this.create_empty_track(k);this.switch_to_track(b,true);var f;while(this.game_tree.actual_move.turn_number<h){f=this.next(0,true);if(!f){throw new Error("Todo mal, no lleguÃ© nunca al root number!");return false}}d=this.ungovar(d,this.get_next_move());var e=/^(0|([1-9]\d*))(\;(B|W)\[[a-s]{2}\])+$/;if(!e.test(d)){return false}var a=d.match(/;.*$/)[0];var g=new SGFParser("(;FF[4]"+a+")");g.sgf_to_tree(this,g.root.last_next,this.game_tree.actual_move,NODE_VARIATION);this.switch_to_track(c,true);return b},switch_to_track:function(b,a){if(!(this.tracks[b] instanceof Track)){return false}this.grid=this.tracks[b].grid;this.tracks[this.actual_track].head=this.game_tree.actual_move;this.game_tree.actual_move=this.tracks[b].head;this.actual_track=b;if(!a){if(this.shower!=undefined){this.shower.redraw()}this.handle_score_agreement()}return true},draw_variation_numbers:function(){var b=this.game_tree.actual_move;if(b.source==NODE_VARIATION){while(b.prev&&b.prev.source==NODE_VARIATION){b=b.prev}if(this.shower!=undefined){var a=1;while(b.next[0]){if(b.play){this.shower.draw_number(b.play,a)}b=b.next[0];a++}if(b.play){this.shower.draw_number(b.play,a)}}}},var_to_string:function(b){var a="";var c=this.game_tree.actual_move;if(c.source!=NODE_VARIATION){return"";throw new Error("No hay jugadas locales.")}while((c.source==NODE_VARIATION||!b)&&!c.root){a=this.data_to_sgf_node(c.play)+a;c=c.prev}if(!b&&c.root&&c.play){a=this.data_to_sgf_node(c.play)+a}else{a=c.turn_number+a}return a},govar:function(){var b=this.var_to_string(true);if(b!=""){var a=b.indexOf(";");b=b.substring(0,a)+" "+b.substring(a,b.length).replace(/(;(W|B)\[|\])/g,"")}return b},ungovar:function(e,c){var b=e.match(/\d\d?\d?/)[0];var g=e.match(/([a-s][a-s])/g);var d=[];d[0]=c;d[1]=(c=="W"?"B":"W");var h="";for(var f=0,a=g.length;f<a;++f){h+=";"+d[f%2]+"["+g[f]+"]"}return b+h},setup_timer:function(a){switch(a.name){case"Absolute":this.timer=new AbsoluteTimer(this,a.settings.main_time);break;case"Fischer":this.timer=new FischerTimer(this,a.settings.main_time,a.settings.bonus);break;case"Canadian":this.timer=new CanadianTimer(this,a.settings.main_time,a.settings.period_time,a.settings.period_stones);break;case"Byoyomi":this.timer=new ByoyomiTimer(this,a.settings.main_time,a.settings.periods,a.settings.period_time);break;case"Bronstein":this.timer=new BronsteinTimer(this,a.settings.main_time,a.settings.bonus);break;case"Hourglass":this.timer=new HourglassTimer(this,a.settings.main_time);break}},update_clocks:function(a){if(this.shower!=undefined){this.shower.update_clocks(a)}},announce_time_loss:function(c){var a=false;if(this.is_my_turn()){switch(this.timer.system.name){case"Absolute":case"Fischer":a=(c[this.get_next_move()]==0);break;case"Byoyomi":var b=c[this.get_next_move()];a=(b.main_time<=0&&b.periods<=1&&b.period_time<=0);break}if(a){if(this.server_path_absolute_url!=undefined&&this.server_path_game_end!=undefined){$.post(this.server_path_absolute_url+this.server_path_game_end,{result:"time_loss"})}if(KAYAGLOBAL!=undefined){KAYAGLOBAL.play_sound("outoftime")}}}},resign:function(){if(this.server_path_absolute_url!=undefined&&this.server_path_game_end!=undefined){$.post(this.server_path_absolute_url+this.server_path_game_end,{result:"resign"})}},change_mode:function(c,b){var a=["play","play_online","free","variation","count","count_online",];if(typeof c=="string"){if(!inArray(c,a)){throw new Error("The 'mode' parameter must be in ("+a+").")}}else{throw new Error("The 'mode' parameter must be a string")}if((this.mode=="count"||this.mode=="count_online")&&c!="count"&&c!="count_online"){this.quit_territory_counting();if(c!="free"&&this.timer!=undefined){this.timer.resume(this.get_next_move())}}if(c=="free"){if(this.shower!=undefined){this.shower.clear_last_stone_markers()}}if(!b){if(c=="play"||c=="play_online"){if(this.shower!=undefined){if(this.game_tree.actual_move.play instanceof Play){this.shower.place_last_stone_marker(this.game_tree.actual_move.play.put)}}}}if(this.mode!="count"&&this.mode!="count_online"&&(c=="count"||c=="count_online")){this.mode=c;this.start_territory_counting();if(this.timer!=undefined){this.timer.pause()}}else{this.mode=c}},quit_territory_counting:function(){if(this.shower!=undefined){this.shower.clear_dead_groups(this.score.dead_groups);this.shower.clear_score()}this.score=undefined;if(this.shower!=undefined){if(this.game_tree.actual_move.play instanceof Play){this.shower.place_last_stone_marker(this.game_tree.actual_move.play.put);this.shower.refresh_ko(this.game_tree.actual_move.play)}this.shower.update_score();this.shower.update_result()}},start_territory_counting:function(){this.score=new Score(this.ruleset,this.grid);var a=this.score.calculate_score();this.score.calculate_result(this.get_captured_count(),this.komi);if(this.shower!=undefined){this.shower.clear_last_stone_markers();this.shower.clear_ko();this.shower.draw_score(a);this.shower.update_score(this.score.score);this.shower.update_result(this.score.result)}},change_ruleset:function(a){var b=["Japanese","Chinese",];if(typeof a=="string"){if(!inArray(a,b)){throw new Error("The ruleset parameter must be in ("+b+").")}}else{throw new Error("The ruleset parameter must be a string")}this.ruleset=a},change_my_colour:function(a){var b=["B","W","A","O",];if(typeof a=="string"){if(!inArray(a,b)){throw new Error("The 'colour' parameter must be in ("+b+").")}}else{throw new Error("The 'colour' parameter must be a string")}this.my_colour=a},change_size:function(a){var b=[19,13,9,];if(typeof a=="number"){if(!inArray(a,b)){throw new Error("The 'size' parameter must be in ("+b+").")}}else{throw new Error("The 'size' parameter must be a number")}if(this.size!=a){this.size=a;this.clear();this.render();this.render_tree()}},change_komi:function(a){if(typeof a!="number"){throw new Error("The 'komi' parameter must be a number")}this.komi=a},clear:function(){this.grid=Array(this.size);for(var a=0;a<this.size;a++){this.grid[a]=Array(this.size)}this.timer=undefined;if(this.sgf!=undefined){this.sgf.init(this.sgf.sgf)}this.game_tree=new GameTree(this.div_id_tree);this.tracks=[];this.tracks[0]=new Track(this.grid,this.game_tree.actual_move);this.actual_track=0;this.turn_count=0;if(this.shower!=undefined){this.shower.clear()}},render:function(){if(this.shower){this.shower.render()}},territory_count:function(){return},connect:function(){this.connected=true},disconnect:function(){this.connected=false},string_to_play:function(c){var b=/^[A-Z]/;var d=b.exec(c)[0];d=d.charCodeAt(0)-65;var e=/[0-9]*$/;var a=parseInt(e.exec(c)[0],10);return{row:d,col:a}},pos_to_sgf_coord:function(b,a){return String.fromCharCode(97+a)+String.fromCharCode(97+b)},sgf_coord_to_pos:function(a){return{row:a.charCodeAt(1)-97,col:a.charCodeAt(0)-97}},data_to_sgf_node:function(d,f){var b=";";if(d instanceof Play){b+=d.put.color+"["+this.pos_to_sgf_coord(d.put.row,d.put.col)+"]"}else{if(d instanceof Pass){b+=d.put.color+"[]"}else{if(d instanceof FreePlay){if(d.remove.length>0){b+="AE";for(var c in d.remove){b+="["+this.pos_to_sgf_coord(d.remove[c].row,d.remove[c].col)+"]"}}if(d.put.length>0){var a=[];a.B="AB";a.W="AW";for(var c in d.put){a[d.put[c].color]+="["+this.pos_to_sgf_coord(d.put[c].row,d.put[c].col)+"]"}if(a.B.length>2){b+=a.B}if(a.W.length>2){b+=a.W}}}}}if(f!=undefined){switch(this.timer.system.name){case"Absolute":case"Fischer":b+=d.put.color+"L["+Number(f[d.put.color]).toFixed(3)+"]";break;case"Byoyomi":if(f[d.put.color].main_time>0){b+=d.put.color+"L["+Number(f[d.put.color].main_time).toFixed(3)+"]"}else{b+=d.put.color+"L["+Number(f[d.put.color].period_time).toFixed(3)+"]O"+d.put.color+"["+f[d.put.color].periods+"]"}break}}return b},send_play:function(a,b){if(this.server_path_absolute_url!=undefined&&this.server_path_game_move!=undefined){$.post(this.server_path_absolute_url+this.server_path_game_move,{move:this.data_to_sgf_node(a,b)})}},send_score_state:function(c,a,b){if(this.server_path_absolute_url!=undefined&&this.server_path_game_move!=undefined){$.post(this.server_path_absolute_url+this.server_path_game_move,{score_state:";"+(b?"A":"D")+"["+this.pos_to_sgf_coord(c,a)+"]"})}},confirm_play:function(){if(this.shower!=undefined){var a=this.game_tree.actual_move.play;if(a instanceof Play){this.shower.confirm_play(a.put)}}},diff_update_game:function(b){if(this.sgf==undefined||this.sgf==null||this.sgf.status!=SGFPARSER_ST_LOADED){this.update_game(b)}else{if(this.timer!=undefined){if(b.result!=undefined){this.timer.stop()}else{this.timer.pause()}}if(b.size!=undefined&&b.size!=this.size){this.change_size(Number(b.size))}var a=false;if(b.moves!=undefined&&b.moves!=null){if(!this.is_attached()){this.attach_head(true);a=this.sgf.add_moves(this,b.moves,true);if(a){this.update_raw_score_state(b.raw_score_state);this.update_timer(b.time_adjustment);this.detach_head(true)}else{return this.update_game(b)}}else{a=this.sgf.add_moves(this,b.moves);if(!a){return this.update_game(b)}}}if(KAYAGLOBAL!=undefined){if(a.play instanceof Play){KAYAGLOBAL.play_sound(a.play.put.color)}else{if(a.play instanceof Pass){KAYAGLOBAL.play_sound("pass")}}}if(this.is_attached()){this.goto_end();this.handle_score_agreement(b.raw_score_state);this.update_timer(b.time_adjustment)}}},update_timer:function(d){if(this.mode=="count"||this.mode=="count_online"){return false}if(this.timer!=undefined){var f;var c;var a=false;var g;var b;var e=this.game_tree.actual_move;while(!a){f=e.play;if(f instanceof Play||f instanceof Pass){c=f.put.color;if(c=="B"&&g==undefined){g=f.time_left}if(c=="W"&&b==undefined){b=f.time_left}}if(b!=undefined&&g!=undefined){a=true}else{e=e.prev;if(e==undefined){a=true}}}switch(this.timer.system.name){case"Absolute":case"Fischer":if(b==undefined){b=Number(this.timer.system.time)}if(g==undefined){g=Number(this.timer.system.time)}break;case"Byoyomi":if(b==undefined){b={main_time:this.timer.system.main_time,period_time:this.timer.system.period_time,periods:this.timer.system.periods,}}if(g==undefined){g={main_time:this.timer.system.main_time,period_time:this.timer.system.period_time,periods:this.timer.system.periods,}}break}this.timer.set_remain("B",g);this.timer.set_remain("W",b);this.timer.resume(this.get_next_move());if(d!=undefined){this.timer.adjust(d)}}},update_game:function(a){this.clear();var b="(;FF[4]";if(a.size){b+="SZ["+a.size+"]"}if(a.time_settings!=undefined){this.setup_timer(a.time_settings)}if(a.moves){b+=a.moves}b+=")";if(this.sgf!=undefined){this.sgf.init(b)}else{this.sgf=new SGFParser(b)}this.sgf.load(this);this.render();this.goto_end();this.handle_score_agreement(a.raw_score_state);this.update_timer(a.time_adjustment);if(this.timer!=undefined){if(a.result!=undefined){this.timer.stop()}}},place_coord_marker:function(b,a){if(this.shower!=undefined){if(this.safe_get_pos(b,a)!=""){this.shower.place_coord_marker(b,a)}}},clear_coord_marker:function(){if(this.shower!=undefined){this.shower.clear_coord_marker()}},handle_score_agreement:function(a){if(this.mode=="count_online"||this.mode=="count"){this.update_raw_score_state(a);this.refresh_score()}else{if(this.check_score_agreement()){if(this.mode=="play_online"){this.change_mode("count_online")}else{if(this.mode=="play"){this.change_mode("count")}}if(a){this.update_raw_score_state(a)}this.refresh_score()}}},check_score_agreement:function(){if(this.mode=="count_online"||this.mode=="count"||this.mode=="variation"){return false}else{var a=this.game_tree.actual_move.prev;var b=this.game_tree.actual_move.play;if(a!=undefined&&a.play instanceof Pass&&b instanceof Pass){return true}else{return false}}},update_raw_score_state:function(a){var b=this.game_tree.actual_move.play;if(b instanceof Pass){b.raw_score_state=a;return true}else{return false}},refresh_score:function(){if(this.mode!="count_online"&&this.mode!="count"){return false}if(this.shower!=undefined){this.shower.clear_dead_groups(this.score.dead_groups)}var a=this.game_tree.actual_move.play.raw_score_state;if(a!=undefined){a=a.match(/;(A|D)\[[a-s]{2}\]/g);for(var e in a){var b=(a[e].charAt(1)=="A");var d=this.sgf_coord_to_pos(a[e].match(/[a-s]{2}/)[0]);var c=this.get_pos(d.row,d.col);if(c==undefined){continue}if(b){this.score.revive_stone(c,d.row,d.col)}else{this.score.kill_stone(c,d.row,d.col)}}}this.draw_score()},draw_score:function(){var a=this.score.calculate_score();this.score.calculate_result(this.get_captured_count(),this.komi);if(this.shower!=undefined){this.shower.draw_dead_groups(this.score.dead_groups);this.shower.clear_score();this.shower.draw_score(a);this.shower.update_score(this.score.score);this.shower.update_result(this.score.result)}},is_attached:function(){return(this.mode=="play_online"||this.mode=="count_online")&&this.actual_track==TRACK_ONLINE},detach_head:function(a){if(this.actual_track==TRACK_ONLINE){if(this.tracks[TRACK_OFFLINE]==undefined){this.duplicate_actual_track(TRACK_OFFLINE)}this.change_mode("variation",a);this.switch_to_track(TRACK_OFFLINE,a)}},attach_head:function(a){if(this.actual_track!=TRACK_ONLINE){this.change_mode("play_online",a);this.switch_to_track(TRACK_ONLINE,a)}},};
// GoValidate
function GoValidate(a){this.init.call(this,a)}GoValidate.prototype={init:function(){this.validate(arguments)},validate:function(rgmnts){rgmnts[0]=rgmnts[0]||{};rgmnts[0][0]=rgmnts[0][0]||{};var args=rgmnts[0][0];var options;with(args){if(typeof size=="undefined"){args.size=19}else{if(typeof size=="number"){options=[9,13,19,];if(!inArray(size,options)){throw new Error("The 'size' parameter must be in ("+options+").")}}else{throw new Error("The 'size' parameter must be a number")}}if(typeof mode=="undefined"){args.mode="play"}else{if(typeof mode=="string"){options=["play","play_online","free","variation","count","count_online",];if(!inArray(mode,options)){throw new Error("The 'mode' parameter must be in ("+options+").")}}else{throw new Error("The 'mode' parameter must be a string")}}if(typeof ruleset=="undefined"){args.ruleset="Japanese"}else{if(typeof ruleset=="string"){options=["Japanese","Chinese",];if(!inArray(ruleset,options)){throw new Error("The 'ruleset' parameter must be in ("+options+").")}}else{throw new Error("The 'ruleset' parameter must be a string")}}if(typeof div_id_board!="undefined"){if(typeof div_id_board!="string"){throw new Error("The 'div_id_board' parameter must be a string")}else{if(!document.getElementById(div_id_board)){throw new Error("The 'div_id_board' parameter points to no existing div.")}}}if(typeof div_id_tree!="undefined"){if(typeof div_id_tree!="string"){throw new Error("The 'div_id_tree' parameter must be a string")}else{if(!document.getElementById(div_id_tree)){throw new Error("The 'div_id_tree' parameter points to no existing div.")}}}if(typeof time_settings!="undefined"){if(typeof time_settings.name!="undefined"){if(typeof time_settings.name!="string"){throw new Error("The 'time_settings.name' parameter must be a string")}else{options=["Absolute","Fischer","Canadian","Byoyomi","Bronstein","Hourglass","Free",];if(!inArray(time_settings.name,options)){throw new Error("The 'time_settings.name' parameter must be in ("+options+").")}}}if(typeof time_settings.div_id_clock_w!="undefined"){if(typeof time_settings.div_id_clock_w!="string"){throw new Error("The 'div_id_clock_w' parameter must be a string")}else{if(!document.getElementById(time_settings.div_id_clock_w)){throw new Error("The 'div_id_clock_w' parameter points to no existing div.")}}}if(typeof time_settings.div_id_clock_b!="undefined"){if(typeof time_settings.div_id_clock_b!="string"){throw new Error("The 'div_id_clock_b' parameter must be a string")}else{if(!document.getElementById(time_settings.div_id_clock_b)){throw new Error("The 'div_id_clock_b' parameter points to no existing div.")}}}}if(typeof div_id_captured_w!="undefined"){if(typeof div_id_captured_w!="string"){throw new Error("The 'div_id_captured_w' parameter must be a string")}else{if(!document.getElementById(div_id_captured_w)){throw new Error("The 'div_id_captured_w' parameter points to no existing div.")}}}if(typeof div_id_captured_b!="undefined"){if(typeof div_id_captured_b!="string"){throw new Error("The 'div_id_captured_b' parameter must be a string")}else{if(!document.getElementById(div_id_captured_b)){throw new Error("The 'div_id_captured_b' parameter points to no existing div.")}}}if(typeof div_id_score_w!="undefined"){if(typeof div_id_score_w!="string"){throw new Error("The 'div_id_score_w' parameter must be a string")}else{if(!document.getElementById(div_id_score_w)){throw new Error("The 'div_id_score_w' parameter points to no existing div.")}}}if(typeof div_id_score_b!="undefined"){if(typeof div_id_score_b!="string"){throw new Error("The 'div_id_score_b' parameter must be a string")}else{if(!document.getElementById(div_id_score_b)){throw new Error("The 'div_id_score_b' parameter points to no existing div.")}}}if(typeof div_id_result!="undefined"){if(typeof div_id_result!="string"){throw new Error("The 'div_id_result' parameter must be a string")}else{if(!document.getElementById(div_id_result)){throw new Error("The 'div_id_result' parameter points to no existing div.")}}}if(typeof div_id_comments!="undefined"){if(typeof div_id_comments!="string"){throw new Error("The 'div_id_comments' parameter must be a string")}else{if(!document.getElementById(div_id_comments)){throw new Error("The 'div_id_comments' parameter points to no existing div.")}}}if(typeof div_id_move_number!="undefined"){if(typeof div_id_move_number!="string"){throw new Error("The 'div_id_move_number' parameter must be a string")}else{if(!document.getElementById(div_id_move_number)){throw new Error("The 'div_id_move_number' parameter points to no existing div.")}}}if(typeof komi!="undefined"){if(typeof komi!="number"){throw new Error("The 'komi' parameter must be a number")}}if(typeof shower!="undefined"){if(typeof shower!="string"){throw new Error("The 'shower' parameter must be a string")}else{options=["shower","graphic",];if(!inArray(shower,options)){throw new Error("The 'shower' parameter must be in ("+options+").")}}}if(typeof my_colour!="undefined"){if(typeof my_colour!="string"){throw new Error("The 'my_colour' parameter must be a string")}else{options=["B","W","A","O",];if(!inArray(my_colour,options)){throw new Error("The 'my_colour' parameter must be in ("+options+").")}}}if(typeof my_nick!="undefined"){if(typeof my_nick!="string"){throw new Error("The 'my_nick' parameter must be a string")}else{if(my_nick==""){throw new Error("The 'my_nick' parameter must not be empty")}}}if(typeof callbacks!="undefined"){var id;for(id in callbacks){if(typeof callbacks[id]!="function"){throw new Error("The callback '"+id+"' must be a function")}}}if(typeof server_path_gospeed_root!="undefined"){if(typeof server_path_gospeed_root!="string"){throw new Error("The 'server_path_gospeed_root' parameter must be a string")}else{if(server_path_gospeed_root==""){throw new Error("The 'server_path_gospeed_root' parameter must not be empty")}else{if(server_path_gospeed_root.charAt(server_path_gospeed_root.length-1)!="/"){args.server_path_gospeed_root+="/"}}}}if(typeof server_path_absolute_url!="undefined"){if(typeof server_path_absolute_url!="string"){throw new Error("The 'server_path_absolute_url' parameter must be a string")}else{if(server_path_absolute_url==""){throw new Error("The 'server_path_absolute_url' parameter must not be empty")}else{if(server_path_absolute_url.charAt(server_path_absolute_url.length-1)!="/"){args.server_path_absolute_url+="/"}}}}if(typeof server_path_game_move!="undefined"){if(typeof server_path_game_move!="string"){throw new Error("The 'server_path_game_move' parameter must be a string")}else{if(server_path_game_move==""){throw new Error("The 'server_path_game_move' parameter must not be empty")}}}if(typeof server_path_game_end!="undefined"){if(typeof server_path_game_end!="string"){throw new Error("The 'server_path_game_end' parameter must be a string")}else{if(server_path_game_end==""){throw new Error("The 'server_path_game_end' parameter must not be empty")}}}}this.clean_args=args},};
// Score
var BLACK="B";var WHITE="W";var EMPTY="*";var BLACK_DEAD="N";var WHITE_DEAD="E";var NO_OWNER="X";var READY="R";function Score(a,b){this.init.apply(this,[a,b])}Score.prototype={init:function(a,b){if(a=="Japanese"){this._deadStonesMultiplier=2}if(a=="Chinese"){this._deadStonesMultiplier=1}this.grid=this.clone_board(b);this.ruleset=a;this.dead_groups=[]},string_grid:function(){var b=this.grid.length;var c="[\n";for(var d in this.grid){c+="[";for(var a in this.grid[d]){c+='"'+this.grid[d][a]+'", '}c+="],\n"}return c+"]"},clone_board:function(c){var d=[];var b=[];for(var e in c){for(var a in c){b[a]=(c[e][a]==undefined?EMPTY:c[e][a])}d.push(b);b=[]}return d},set_dead_group:function(d){var c=d.length;if(c<=0){return false}var a=(d[0].color==BLACK?BLACK_DEAD:WHITE_DEAD);for(var b=0;b<c;b++){this.grid[d[b].row][d[b].col]=a}},kill_stone:function(b,g,d){if(b==BLACK){if(this.grid[g][d]==BLACK_DEAD){return false}this.grid[g][d]=BLACK_DEAD}else{if(this.grid[g][d]==WHITE_DEAD){return false}this.grid[g][d]=WHITE_DEAD}this.clear_visited();var f=this.connected_component(g,d).deads[b];f.push({color:b,row:g,col:d});this.dead_groups.push(f);var c=(b==BLACK?BLACK_DEAD:WHITE_DEAD);for(var e=0,a=f.length;e<a;++e){this.grid[f[e].row][f[e].col]=c}return true},revive_stone:function(a,f,c){if(this.grid[f][c]==BLACK||this.grid[f][c]==WHITE){return false}var e;var d=0;while(d<this.dead_groups.length){if(inArrayDeep({color:a,row:f,col:c},this.dead_groups[d])){e=this.dead_groups.splice(d,1)[0];for(var b=0,g=e.length;b<g;++b){this.grid[e[b].row][e[b].col]=e[b].color}}else{d++}}return true},clear_visited:function(){var a=this.grid.length;this.visited=Array(a);for(var b=0;b<a;b++){this.visited[b]=Array(a)}},calculate_score:function(){var e=this.grid;var j=e.length;var a;var k={white_points:0,black_points:0,groups:[]};this.clear_visited();for(var c=0,f=this.dead_groups.length;c<f;++c){this.set_dead_group(this.dead_groups[c])}for(var h=0;h<j;++h){for(var b=0;b<j;++b){a=e[h][b];if(a==EMPTY){k.groups=k.groups.concat(this.connected_component(h,b))}else{if(this.ruleset=="Chinese"){if(a==WHITE){k.white_points++}else{if(a==BLACK){k.black_points++}}}}}}var g;for(var d in k.groups){g=k.groups[d];if(g.owner==BLACK){k.black_points+=g.score+(g.dead_count.W*this._deadStonesMultiplier)}else{if(g.owner==WHITE){k.white_points+=g.score+(g.dead_count.B*this._deadStonesMultiplier)}}}this.white_points=k.white_points;this.black_points=k.black_points;return k},calculate_result:function(c,e){var d=0;var b=0;if(e!=undefined){if(e>0){d+=e}else{b+=Math.abs(e)}}if(this.white_points!=undefined){d+=this.white_points}if(this.black_points!=undefined){b+=this.black_points}if(c!=undefined){if(c[BLACK]!=undefined){d+=c[BLACK]}if(c[WHITE]!=undefined){b+=c[WHITE]}}this.score={};this.score[BLACK]=b;this.score[WHITE]=d;var a=d-b;if(a==0){this.result="Jigo"}else{if(a<0){this.result="B+"+Math.abs(a)}else{this.result="W+"+a}}return this.result},connected_component:function(a,f){var c=this.grid;var b=c.length;var e=[[a,f]];var d={owner:null,score:0,deads:{B:[],W:[],},dead_count:{B:0,W:0,},coords:[],};while(current_coord=e.shift()){a=current_coord[0];f=current_coord[1];if(a<0||a>=b||f<0||f>=b){continue}if(this.visited[a][f]!=undefined){continue}switch(c[a][f]){case (EMPTY):d.score++;d.coords.push({row:a,col:f});this.visited[a][f]=READY;e=e.concat([[a-1,f],[a+1,f],[a,f-1],[a,f+1]]);break;case (BLACK_DEAD):d.dead_count.B++;d.coords.push({row:a,col:f});this.visited[a][f]=READY;e=e.concat([[a-1,f],[a+1,f],[a,f-1],[a,f+1]]);break;case (WHITE_DEAD):d.dead_count.W++;d.coords.push({row:a,col:f});this.visited[a][f]=READY;e=e.concat([[a-1,f],[a+1,f],[a,f-1],[a,f+1]]);break;case (BLACK):if(d.dead_count.B>0){d.deads.B.push({color:BLACK,row:a,col:f});d.dead_count.B++;d.coords.push({row:a,col:f});this.visited[a][f]=READY;e=e.concat([[a-1,f],[a+1,f],[a,f-1],[a,f+1]])}else{if(!d.owner){d.owner=BLACK}else{if(d.owner==WHITE){d.owner=NO_OWNER}}}break;case (WHITE):if(d.dead_count.W>0){d.deads.W.push({color:WHITE,row:a,col:f});d.dead_count.W++;d.coords.push({row:a,col:f});this.visited[a][f]=READY;e=e.concat([[a-1,f],[a+1,f],[a,f-1],[a,f+1]])}else{if(!d.owner){d.owner=WHITE}else{if(d.owner==BLACK){d.owner=NO_OWNER}}}break}}return d}};
// SGF
var SGFPARSER_ST_ERROR=1;var SGFPARSER_ST_PARSED=2;var SGFPARSER_ST_LOADED=4;function SGFNode(){this.prev=null;this.next=[];this.last_next=null}SGFNode.prototype={appendNext:function(a){a.prev=this;this.next.push(a);if(this.last_next==null){this.last_next=a}}};function SGFParser(a){this.init.apply(this,[a])}SGFParser.prototype={init:function(a){this.sgf=a;this.root=null;this.pointer=null;this.last_node=null;this.moves_loaded="";this.parse()},append_node:function(a){if(this.pointer==this.root&&!this.root.loaded){for(var b in a){this.root[b]=a[b]}this.root.loaded=true}else{a.prev=this.pointer;this.pointer.next.push(a);this.pointer.last_next=a;this.pointer=a;this.last_node=a}},parse:function(){this.root=new SGFNode();this.pointer=this.root;this.last_node=this.root;var f;var g=[];var c="";var k=this.sgf.length;var d=0;var h=false;var j;var e;var a=[];var b=/^[a-z]{2}$/;while(d<k){c=this.sgf[d];switch(c){case"\\":h=true;break;case"(":g.push(this.pointer);break;case")":this.pointer=g.pop();break;case";":if(!h){d+=this.sgf_handle_node(this.sgf,d+1)}break;default:if(!/\s/.test(c)){this.status=SGFPARSER_ST_ERROR;this.error="Unexpected character";return false}break}d++}if(this.root==null){this.status=SGFPARSER_ST_ERROR;this.error="Empty SGF";return false}else{this.status=SGFPARSER_ST_PARSED;return true}},sgf_handle_node:function(a,i){var d=false;var h=i;var j=/^[A-Z]$/;var g="";var b="";var f=[];var c="";var e=false;this.append_node(new SGFNode());while(!d){while(!d){c=a[h];if(j.test(c)){g+=c}else{if(c=="["){d=true}}h++}d=false;while(!d){c=a[h];if(c=="\\"){e=true}else{if(!e&&c=="]"){f.push(b);b="";if(a[h+1]!="["){d=true}else{h++}}else{b+=c;e=false}}h++}if(f.length==1){f=f[0]}this.pointer[g]=f;f=[];g="";b="";h+=this.sgf_eat_blank(a,h);if(j.test(a[h])){d=false}}return h-i},sgf_eat_blank:function(b,c){var d=c;var e="";var a=false;while(!a){e=b[d];switch(e){case"\r":break;case"\n":break;case" ":break;case"\\":esc_next=true;break;default:a=true;break}d++}return d-c-1},load:function(a){if(this.status==SGFPARSER_ST_PARSED){if(!this.root){return false}a.clear();this.moves_loaded="";this.process_root_node(a);if(!this.sgf_to_tree(a,this.root,a.game_tree.root,NODE_SGF)){if(this.status==SGFPARSER_ST_ERROR){throw new Error(this.error)}else{throw new Error("Unknown error no 001")}return false}this.rewind_game(a);a.render();a.render_tree()}else{return false}this.status=SGFPARSER_ST_LOADED;return true},process_root_node:function(d){var f=this.root;if(f.RU!=undefined){d.change_ruleset(f.RU)}if(f.KM!=undefined){d.change_komi(Number(f.KM))}if(f.SZ!=undefined){d.change_size(Number(f.SZ))}if(f.C!=undefined){if(d.game_tree!=undefined&&d.game_tree.root!=undefined){d.game_tree.root.comments=f.C}}var b={};if(f.OT!=undefined){if(/fischer/i.test(f.OT)){var g=f.OT.match(/\d+(\.\d+)?/);if(g){b.name="Fischer";b.settings={bonus:parseFloat(g[0]),}}}else{if(/byo-?yomi/i.test(f.OT)){var a=f.OT.match(/(\d+)[x\/](\d+)/i);if(a[1]&&a[2]){b.name="Byoyomi";b.settings={periods:parseInt(a[1],10),period_time:parseInt(a[2],10),}}}}}if(b.name==undefined){if(f.TM!=undefined){b.name="Absolute";b.settings={main_time:parseFloat(f.TM),}}else{b.name="Free"}}else{if(f.TM==undefined){b.settings.main_time=0}else{b.settings.main_time=parseFloat(f.TM)}}d.setup_timer(b);if(f.AB!=undefined||f.AW!=undefined){var e=new FreePlay();e.captured={B:0,W:0};d.game_tree.root.play=e;if(f.AB!=undefined){f.AB=[].concat(f.AB);for(var c in f.AB){e.put.push(new Stone("B",f.AB[c].charCodeAt(1)-97,f.AB[c].charCodeAt(0)-97))}}if(f.AW!=undefined){f.AW=[].concat(f.AW);for(var c in f.AW){e.put.push(new Stone("W",f.AW[c].charCodeAt(1)-97,f.AW[c].charCodeAt(0)-97))}}d.make_play(e);if(d.shower!=undefined){d.shower.draw_play(e)}}if(f.HA!=undefined){d.game_tree.root.next_move="W"}if(f.PL!=undefined){d.game_tree.root.next_move=f.PL}},sgf_to_tree:function(h,f,j,e){var k=[];var a=[];k.push(f);a.push(j);var b;var g;var d;var j;while(f=k.pop()){j=a.pop();j.last_next=j.next[0];while(h.game_tree.actual_move!=j){d=h.game_tree.prev();h.undo_play(d.play)}if(f.B!=undefined||f.W!=undefined){if(h.get_next_move()=="B"&&f.B!=undefined){b=f.B;g=this.get_time_from_node(h.timer,f.BL,f.OB)}else{if(h.get_next_move()=="W"&&f.W!=undefined){b=f.W;g=this.get_time_from_node(h.timer,f.WL,f.OW)}else{this.status=SGFPARSER_ST_ERROR;this.error="Turn and Play mismatch";return false}}if(b==""||(h.size<20&&b=="tt")){d=new Pass(h.get_next_move());h.update_play_captures(d)}else{d=h.setup_play(b.charCodeAt(1)-97,b.charCodeAt(0)-97);if(!d){this.status=SGFPARSER_ST_ERROR;this.error="Illegal move or such...";return false}}d.time_left=g;this.moves_loaded+=";"+d.put.color+"["+b+"]";h.game_tree.append(new GameNode(d,e,f.C));h.make_play(d);if(g!=undefined&&!isNaN(g)&&h.timer!=undefined){h.timer.set_remain(d.put.color,g)}if(d instanceof Play||d instanceof Pass){h.turn_count++}}for(var c=f.next.length-1;c>=0;--c){k.push(f.next[c]);a.push(h.game_tree.actual_move)}}return true},rewind_game:function(c,a){var b;while(c.game_tree.actual_move!=c.game_tree.root){b=c.game_tree.prev();c.undo_play(b.play);if(a!=undefined){a--;if(a<=0){break}}}},add_moves:function(m,g,d){var h=this.parse_only_moves(g);var k;if(h.length==this.moves_loaded.length){if(h[h.length-1]==this.moves_loaded[this.moves_loaded.length-1]){m.confirm_play();return true}else{return false}}else{if(h.length>this.moves_loaded.length){k=h.substring(0,this.moves_loaded.length);h=h.substring(this.moves_loaded.length)}else{return false}}if(k!=this.moves_loaded){return false}var a=h.match(/;/g).length;var f=g.length;for(var c=0;c<a;++c){f=g.lastIndexOf(";",f-1)}var b=g.substring(f);var l=this.last_node;this.pointer=l;for(var c=0,j=b.length;c<j;++c){c+=this.sgf_handle_node(b,c+1)}this.pointer=l.last_next;this.sgf_to_tree(m,this.pointer,m.game_tree.actual_move,NODE_ONLINE);var e=m.game_tree.actual_move;if(!d){this.rewind_game(m,a)}return e},parse_only_moves:function(b){var a=b.match(/;(B|W)\[([a-z]{2})?\]/g);if(a){return a.join("")}else{return""}},sgf_to_data:function(){var b="";if(this.root!=null){var f="";var d=this.root;var a=false;while(!a){for(var c in d.properties){f=d.properties[c].prop;if(f=="B"||f=="W"){val=d.properties[c].val.toUpperCase();b+=val[0]+"-"+(val.charCodeAt(1)-65)+","}}d=d.last_next;if(d==null){a=true}}}return b},get_time_from_node:function(d,c,b){if(d!=undefined&&d.system!=undefined&&d.system.name!=undefined){switch(d.system.name){case"Free":case"Absolute":case"Fischer":return parseFloat(c);break;case"Byoyomi":var a;if(b!=undefined){a={main_time:0,periods:parseInt(b,10),period_time:parseFloat(c),}}else{a={main_time:parseFloat(c),}}return a;break;case"Canadian":var a;if(b!=undefined){a={main_time:0,period_time:parseFloat(c),period_stones:parseInt(b,10),}}else{a={main_time:parseFloat(c),}}return a;break}}else{return undefined}},};
// Stone
function Stone(a,c,b){this.init.call(this,a,c,b)}Stone.prototype={init:function(a,c,b){if(a!="W"&&a!="B"){throw new Error("El color debe ser 'B' o 'W'.")}this.color=a;this.row=c;this.col=b},toString:function(){return this.color+": ("+this.row+", "+this.col+")"},equals:function(b){for(var a in this){if(this[a]!=b[a]){return false}}return true},compareTo:function(d,c){if(c.row!=d.row){return c.row-d.row}else{return c.col-d.col}},};Stone.compair=function(d,c){return d.compareTo(c)};
// Utils
var NODE_SGF=1;var NODE_ONLINE=2;var NODE_OFFLINE=4;var NODE_VARIATION=8;function Play(a,c,b){this.put=new Stone(a,c,b);this.remove=[]}Play.prototype={toString:function(){var a="Play:\n\t";a+="Put: "+this.put+"\n\t";a+="Remove("+this.remove.length+") {";for(stone in this.remove){a+="\n\t\t"+this.remove[stone]+","}a+="\n\t}";return a},};function FreePlay(){this.put=[];this.remove=[]}FreePlay.prototype={toString:function(){var a="Play:\n\t";a+="Put("+this.put.length+") {";for(stone in this.put){a+="\n\t\t"+this.put[stone]+","}a+="\n\t}\n";a+="Remove("+this.remove.length+") {";for(stone in this.remove){a+="\n\t\t"+this.remove[stone]+","}a+="\n\t}";return a},get_put_by_pos:function(b,a){for(stone in this.put){if(this.put[stone].row==b&&this.put[stone].col==a){return[stone,this.put[stone]]}}return false},get_rem_by_pos:function(b,a){for(stone in this.remove){if(this.remove[stone].row==b&&this.remove[stone].col==a){return[stone,this.remove[stone]]}}return false},clean_pos:function(c,a){var b;b=0;while(b<this.put.length){if(this.put[b].row==c&&this.put[b].col==a){this.put.splice(b,1)}else{b++}}b=0;while(b<this.remove.length){if(this.remove[b].row==c&&this.remove[b].col==a){this.remove.splice(b,1)}else{b++}}}};function Pass(a){if(a=="W"||a=="B"){this.put={color:a}}else{throw new Error("Pass requires a color.")}}function GameTree(a){this.root=new GameNode(null);this.root.root=true;this.root.turn_number=0;this.actual_move=this.root;if(a!=undefined){this.graphic=new GameTreeGraphic(this,a)}}GameTree.prototype={append:function(d,b){d.prev=this.actual_move;d.turn_number=this.actual_move.turn_number+1;this.actual_move.next.push(d);if(b){this.actual_move.last_next=d}else{var e=null;for(var c=0,a=this.actual_move.next.length;c<a;++c){if(this.actual_move.next[c].source!=NODE_VARIATION){e=this.actual_move.next[c];break}}this.actual_move.last_next=e}this.actual_move=d},next:function(a){var b=this.actual_move.next;if(b.length==0){return false}else{if(b[a]!=undefined){this.actual_move=b[a]}else{if(this.actual_move.last_next!=undefined){this.actual_move=this.actual_move.last_next}else{return false}}}return this.actual_move},prev:function(){var a;if(this.actual_move.play==null||this.actual_move.prev==null){return false}else{a=this.actual_move;this.actual_move=this.actual_move.prev;return a}},up:function(){var a;if(this.actual_move!=null){if(this.actual_move.next.length>1){a=this.actual_move.next.indexOf(this.actual_move.last_next);if(a>0){this.actual_move.last_next=this.actual_move.next[a-1]}}}},down:function(){var a;if(this.actual_move!=null){if(this.actual_move.next.length>1){a=this.actual_move.next.indexOf(this.actual_move.last_next);if(a<this.actual_move.next.length-1){this.actual_move.last_next=this.actual_move.next[a+1]}}}},render_tree:function(){if(this.graphic!=undefined){this.graphic.draw()}},test_path:function(c){var d=this.root;for(var b=0,a=c.length;b<a;++b){if(d.next.hasOwnProperty(c[b])){d=d.next[c[b]]}else{return false}}return true},recRunTree:function(f,c,h,g){function b(i){if(i<10){return"&nbsp;&nbsp;"+i}else{if(i<100){return"&nbsp;"+i}else{return i}}}var d,e,a;if(f.next.length==0){return c+=(this.actual_move==f?'<span style="'+(g?"color: #000;":"color: #888;")+'"><span style="text-decoration: underline;">'+(f.play instanceof FreePlay?"&nbsp;F!":b(h))+"</span> - </span>":'<span style="'+(g?"color: #000;":"color: #888;")+'">'+(f.play instanceof FreePlay?"&nbsp;F!":b(h))+" - </span>")}else{e="";a="";for(var d=0;d<h;d++){e+="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"}e+="&nbsp;&nbsp;&bull;&nbsp;-&nbsp;";a+=this.recRunTree(f.next[0],c+(this.actual_move==f?'<span style="'+(g?"color: #000;":"color: #888;")+'"><span style="text-decoration: underline;">'+(f.play instanceof FreePlay?"&nbsp;F!":b(h))+"</span> - </span>":'<span style="'+(g?"color: #000;":"color: #888;")+'">'+(f.play instanceof FreePlay?"&nbsp;F!":b(h))+" - </span>"),h+1,g&&(f.last_next==f.next[0]));for(var d=1;d<f.next.length;d++){a+="<br />"+e+this.recRunTree(f.next[d],"",h+1,g&&(f.last_next==f.next[d]))}return a}},toString:function(){return this.recRunTree(this.root,"",0,true)},};function GameTreeGraphic(a,b){if(a==undefined){throw new Error("A tree is needed.")}this.game_tree=a;if(b!=undefined){this.div_tree=document.getElementById(b)}}GameTreeGraphic.prototype={draw:function(){this.div_tree.innerHTML="";var b=0;var e;var d;var a=[];a.push({lvl:0,elem:this.game_tree.root});while(e=a.pop()){for(var c=e.elem.next.length-1;c>=0;--c){a.push({lvl:(c>0?1:0),elem:e.elem.next[c]})}b+=e.lvl;var f=document.createElement("div");if(e.elem.play!=undefined&&e.elem.play.put!=undefined){if(e.elem.play.put.color=="B"){f.className="TreeNode B"}else{f.className="TreeNode W"}}else{f.className="TreeNode"}f.style.top=(b*27+5)+"px";f.style.left=(e.elem.turn_number*27+5)+"px";f.innerHTML=e.elem.turn_number;if(e.elem==this.game_tree.actual_move){f.style.backgroundColor="#ACA";d=b}this.div_tree.appendChild(f)}this.div_tree.scrollTop=(d-2)*27+5;this.div_tree.scrollLeft=(this.game_tree.actual_move.turn_number-5)*27+5}};function GameNode(b,a,c){this.play=b;this.prev=null;this.next=[];this.last_next=undefined;this.source=a;this.comments=c}GameNode.prototype.get_pos=function(){if(this.prev){var c=this.prev.next;for(var b=0,a=c.length;b<a;b++){if(c[b]===this){return b}}}return false};GameNode.prototype.get_path=function(){var c,b=[],a=this;while(a){c=a.get_pos();if(c!==false){b.push(c)}a=a.prev}return b.reverse()};function Track(b,a){this.grid=b;this.head=a}function inArray(d,c){var b=c.length;for(var a=0;a<b;a++){if(c[a]==d){return true}}return false}function inArrayDeep(f,e){var d=e.length;var c=true;for(var b=0;b<d;b++){if(e[b].length!=f.length){continue}for(var a in f){if(e[b][a]!=f[a]){c=false;break}else{continue}}if(c){return true}else{c=true}}return false};
